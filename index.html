<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Mercado Local</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
        }
        
        #canvas-container {
            width: 100%;
            height: 100%;
            position: relative;
            cursor: pointer;
        }
        
        #start-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
            color: white;
            flex-direction: column;
        }

        #start-button {
            padding: 15px 30px;
            font-size: 20px;
            cursor: pointer;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 10px;
        }
        
        #ui-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            max-width: 300px;
            z-index: 10;
        }

        #budget-display {
            font-size: 20px;
            font-weight: bold;
            color: #4CAF50;
            margin-top: 10px;
            text-shadow: 1px 1px 2px black;
        }
        
        #dialogue-box {
            position: absolute;
            top: 20px;
            right: 20px;
            bottom: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 400px;
            width: 30%;
            backdrop-filter: blur(10px);
            z-index: 10;
            display: none;
            flex-direction: column;
        }
        
        #dialogue-box h3 {
            margin: 0 0 10px 0;
            color: #81C784; /* Lighter green for dark background */
        }
        
        #dialogue-content {
            margin-bottom: 10px;
            line-height: 1.6;
            overflow-y: auto;
            flex-shrink: 1;
        }

        .product-list {
            list-style: none;
            padding: 0;
        }

        .product-list li {
            display: grid;
            grid-template-columns: 1fr auto auto;
            align-items: center;
            padding: 8px;
            gap: 10px;
            border-bottom: 1px solid #444;
        }
        
        .product-name {
            font-size: 14px;
        }

        .product-price {
            font-size: 12px;
            color: #ccc;
        }

        .quantity-selector {
            display: flex;
            align-items: center;
        }

        .quantity-btn {
            background-color: #555;
            border: none;
            color: white;
            cursor: pointer;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            font-weight: bold;
        }
        
        .quantity-display {
            margin: 0 10px;
            font-weight: bold;
            min-width: 35px;
            text-align: center;
        }

        .add-to-cart-btn {
            background-color: #5D9C59;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .add-to-cart-btn:hover {
            background-color: #4a7d47;
        }

        .add-to-cart-btn:disabled {
            background-color: #777;
            cursor: not-allowed;
        }

        #interaction-area {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #555;
        }
        
        .interaction-btn {
             width: 100%;
            background-color: #f0ad4e;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 5px;
            margin-top: 5px;
            cursor: pointer;
        }
        
        #interaction-display {
            margin-top: 10px;
            font-style: italic;
            color: #ddd;
            background: #222;
            padding: 8px;
            border-radius: 5px;
        }

        #interaction-input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            margin-bottom: 5px;
            background-color: #333;
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
        }

        #cart-summary {
            margin-top: auto;
            padding-top: 10px;
            border-top: 2px solid #555;
            flex-shrink: 0;
        }

        #cart-summary h4 {
            margin: 0 0 5px 0;
        }

        #cart-items {
            font-size: 14px;
            max-height: 80px;
            overflow-y: auto;
        }
        
        #payment-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 15px;
        }

        .payment-option-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .payment-option-btn:hover {
            background-color: #1976D2;
        }
        
        #interaction-prompt {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            display: none;
            font-size: 14px;
            z-index: 10;
        }
        
    </style>
</head>
<body>
    <div id="canvas-container">
        <div id="start-overlay">
            <h1>Simulador de Mercado</h1>
            <button id="start-button">Iniciar</button>
        </div>
    </div>
    
    <div id="ui-overlay">
        <h2 id="title"></h2>
        <p style="font-size: 20px;" id="subtitle"></p>
        <div id="budget-display"></div>
        <p id="move-instruction"></p>
        <p id="look-instruction"></p>
        <p id="interact-instruction"></p>
        <p id="close-instruction"></p>
    </div>
    
    <div id="dialogue-box">
        <h3 id="dialogue-name">Name</h3>
        <div id="dialogue-content"></div>
        <div id="interaction-area"></div>
        <div id="cart-summary" style="display: none;">
            <h4 id="cart-title"></h4>
            <div id="cart-items"></div>
            <div id="payment-options"></div>
        </div>
    </div>
    
    <div id="interaction-prompt"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Translations
        const TRANSLATIONS = {
            "en-US": {
                "title": "Local Market Simulator",
                "subtitle": "ðŸŽ Buy fresh goods!",
                "moveInstruction": "Use WASD to move around",
                "lookInstruction": "Arrow keys or mouse to look left/right",
                "interactInstruction": "Press E to talk to vendors",
                "closeInstruction": "Press ESC to close dialogs/release mouse",
                "pressEToTalkTo": "Press E to talk to",
                "todaysOffer": "Welcome to my stall! My products are top quality. What can I get for you?",
                "addToCartButton": "Add",
                "cartTitle": "Your Cart",
                "payWith": "Pay with",
                "exacto": "Exact",
                "change": "Change",
                "payButton": "Pay",
                "budgetLabel": "Budget",
                "askQuestionButton": "Ask a question",
                "askPlaceholder": "Ask a question...",
                "unit_pound": "lb",
                "unit_each": "each",
                "generating": "Generating...",
                "confirm_add": "Yes, add",
                "confirm_cancel": "No, thanks"
            },
            "es-ES": {
                "title": "Simulador de Mercado Local",
                "subtitle": "ðŸŽ Â¡Compra productos frescos!",
                "moveInstruction": "Usa WASD para moverte",
                "lookInstruction": "Teclas de direcciÃ³n o ratÃ³n para mirar izquierda/derecha",
                "interactInstruction": "Presiona E para hablar con los vendedores",
                "closeInstruction": "Presiona ESC para cerrar diÃ¡logos/liberar ratÃ³n",
                "pressEToTalkTo": "Presiona E para hablar con",
                "todaysOffer": "Â¡Bienvenido/a a mi puesto! Mis productos son de primera. Â¿QuÃ© se le ofrece?",
                "addToCartButton": "AÃ±adir",
                "cartTitle": "Su Canasta",
                "payWith": "Pagar con",
                "exacto": "Exacto",
                "change": "Cambio",
                "payButton": "Pagar",
                "budgetLabel": "Presupuesto",
                "askQuestionButton": "Hacer una pregunta",
                "askPlaceholder": "Hacer una pregunta...",
                "unit_pound": "libra",
                "unit_each": "unidad",
                "generating": "Generando...",
                "confirm_add": "SÃ­, agregar",
                "confirm_cancel": "No, gracias"
            }
        };

        // Language detection
        const browserLocale = navigator.languages?.[0] || navigator.language || 'en-US';
        const findMatchingLocale = (locale) => {
            if (TRANSLATIONS[locale]) return locale;
            const lang = locale.split('-')[0];
            const match = Object.keys(TRANSLATIONS).find(key => key.startsWith(lang + '-'));
            return match || 'en-US';
        };
        const locale = findMatchingLocale(browserLocale);
        const t = (key) => TRANSLATIONS[locale]?.[key] || TRANSLATIONS['en-US'][key] || key;

        // Game state
        let playerBudget = 50.00;

        // Update UI text
        document.getElementById('title').textContent = t('title');
        document.getElementById('subtitle').textContent = t('subtitle');
        document.getElementById('move-instruction').textContent = t('moveInstruction');
        document.getElementById('look-instruction').textContent = t('lookInstruction');
        document.getElementById('interact-instruction').textContent = t('interactInstruction');
        document.getElementById('close-instruction').textContent = t('closeInstruction');
        document.getElementById('cart-title').textContent = t('cartTitle');
        
        const budgetDisplayDiv = document.getElementById('budget-display');
        function updateBudgetDisplay() {
            budgetDisplayDiv.textContent = `${t('budgetLabel')}: $${playerBudget.toFixed(2)}`;
        }
        updateBudgetDisplay();

        // Scene setup
        const canvasContainer = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        
        const camera = new THREE.PerspectiveCamera(75, canvasContainer.clientWidth / canvasContainer.clientHeight, 0.1, 1000);
        camera.position.set(0, 1.6, 8);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        canvasContainer.appendChild(renderer.domElement);
        
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(20, 30, 15);
        directionalLight.castShadow = true;
        scene.add(directionalLight);

        const floorGeometry = new THREE.PlaneGeometry(80, 80);
        const floorMaterial = new THREE.MeshStandardMaterial({ color: 0x969696, roughness: 0.8 });
        const floor = new THREE.Mesh(floorGeometry, floorMaterial);
        floor.rotation.x = -Math.PI / 2;
        floor.receiveShadow = true;
        scene.add(floor);
        
        function createStall(x, z, canopyColor1, canopyColor2) {
            const stallGroup = new THREE.Group();
            const woodMaterial = new THREE.MeshStandardMaterial({ color: 0x8B4513, roughness: 0.7 });
            const clothMaterial1 = new THREE.MeshStandardMaterial({ color: canopyColor1 });
            const clothMaterial2 = new THREE.MeshStandardMaterial({ color: canopyColor2 });
            const tableTop = new THREE.Mesh(new THREE.BoxGeometry(3, 0.15, 1.5), woodMaterial);
            tableTop.position.y = 0.8;
            tableTop.castShadow = true;
            stallGroup.add(tableTop);
            const legGeo = new THREE.BoxGeometry(0.1, 0.8, 0.1);
            const legPositions = [[-1.4, 0.4, -0.65], [1.4, 0.4, -0.65], [-1.4, 0.4, 0.65], [1.4, 0.4, 0.65]];
            legPositions.forEach(pos => {
                const leg = new THREE.Mesh(legGeo, woodMaterial);
                leg.position.set(...pos);
                stallGroup.add(leg);
            });
            const poleGeo = new THREE.CylinderGeometry(0.05, 0.05, 2.5, 8);
            const polePositions = [[-1.4, 1.25, -0.65], [1.4, 1.25, -0.65]];
            polePositions.forEach(pos => {
                const pole = new THREE.Mesh(poleGeo, woodMaterial);
                pole.position.set(...pos);
                stallGroup.add(pole);
            });
            const canopy = new THREE.Mesh(new THREE.BoxGeometry(3.2, 0.1, 1.8), woodMaterial);
            for (let i = 0; i < 10; i++) {
                const stripe = new THREE.Mesh(new THREE.BoxGeometry(3.2 / 10, 0.11, 1.8), i % 2 === 0 ? clothMaterial1 : clothMaterial2);
                stripe.position.set(-1.44 + i * 0.32, 0, 0);
                canopy.add(stripe);
            }
            canopy.position.set(0, 2.5, 0);
            canopy.rotation.z = -0.1;
            stallGroup.add(canopy);
            for (let i = 0; i < 10; i++) {
                const productGeo = Math.random() > 0.5 ? new THREE.BoxGeometry(0.2, 0.2, 0.3) : new THREE.SphereGeometry(0.1, 8, 8);
                const productMat = new THREE.MeshStandardMaterial({ color: new THREE.Color(Math.random(), Math.random(), Math.random()) });
                const product = new THREE.Mesh(productGeo, productMat);
                product.position.set(Math.random() * 2 - 1, 0.95, Math.random() * 1 - 0.5);
                stallGroup.add(product);
            }
            stallGroup.position.set(x, 0, z);
            return stallGroup;
        }

        const characters = [];
        const characterData = [
            { name: "Elena, la de las Verduras", pos: [-10, -5], wares: [{name: "Tomates", price: 0.65, unit: "pound"}, {name: "Cebolla", price: 0.25, unit: "each"}, {name: "Chile Verde", price: 0.20, unit: "each"}, {name: "Papas", price: 0.40, unit: "pound"}, {name: "Lechuga", price: 0.80, unit: "each"}, {name: "Pepino", price: 0.30, unit: "each"}, {name: "Zanahorias", price: 0.25, unit: "pound"}, {name: "BrÃ³coli", price: 1.15, unit: "each"}, {name: "Ajo (cabeza)", price: 0.50, unit: "each"}, {name: "Cilantro (manojo)", price: 0.50, unit: "each"}], colors: [0x228b22, 0xffffff] },
            { name: "Marco, el de los Granos", pos: [10, -5], wares: [{name: "Frijoles", price: 1.19, unit: "pound"}, {name: "Arroz", price: 0.65, unit: "pound"}, {name: "MaÃ­z", price: 0.40, unit: "pound"}, {name: "AzÃºcar", price: 0.50, unit: "pound"}, {name: "Sal", price: 0.25, unit: "pound"}, {name: "CafÃ© Molido", price: 4.75, unit: "pound"}, {name: "Avena", price: 1.50, unit: "pound"}, {name: "Lentejas", price: 0.90, unit: "pound"}, {name: "Harina de Trigo", price: 0.80, unit: "pound"}, {name: "ConsomÃ© de Pollo", price: 0.10, unit: "each"}], colors: [0xdaa520, 0xffffff] },
            { name: "Lira, la de los LÃ¡cteos", pos: [-10, 10], wares: [{name: "Queso Fresco", price: 2.49, unit: "pound"}, {name: "Queso Duro Blando", price: 3.00, unit: "pound"}, {name: "Crema Pura", price: 2.10, unit: "pound"}, {name: "RequesÃ³n", price: 1.50, unit: "pound"}, {name: "Leche (botella)", price: 1.25, unit: "each"}, {name: "Huevos (cartÃ³n)", price: 3.95, unit: "each"}, {name: "Mantequilla", price: 1.00, unit: "each"}, {name: "Yogurt Natural", price: 0.80, unit: "each"}, {name: "Cuajada", price: 1.75, unit: "pound"}, {name: "Quesillo", price: 3.50, unit: "pound"}], colors: [0x9932cc, 0x000000] },
            { name: "Bardo, el Carnicero", pos: [10, 10], wares: [{name: "Carne de Res", price: 4.89, unit: "pound"}, {name: "Pollo Entero", price: 5.25, unit: "each"}, {name: "Chuleta de Cerdo", price: 3.75, unit: "pound"}, {name: "Chorizos", price: 2.50, unit: "pound"}, {name: "Longaniza", price: 2.50, unit: "pound"}, {name: "Costilla de Res", price: 4.00, unit: "pound"}, {name: "Pechuga de Pollo", price: 2.85, unit: "pound"}, {name: "Carne Molida", price: 3.50, unit: "pound"}, {name: "Salchichas", price: 1.50, unit: "pound"}, {name: "Bistec de Res", price: 5.00, unit: "pound"}], colors: [0xDC143C, 0xffffff] },
            { name: "Gael, el Frutero", pos: [0, -10], wares: [{name: "Guineo", price: 0.12, unit: "each"}, {name: "Naranja", price: 0.15, unit: "each"}, {name: "Mango de Temporada", price: 0.50, unit: "each"}, {name: "PiÃ±a", price: 1.45, unit: "each"}, {name: "SandÃ­a", price: 2.00, unit: "each"}, {name: "Papaya", price: 1.25, unit: "each"}, {name: "MelÃ³n", price: 1.75, unit: "each"}, {name: "Limones (5)", price: 0.50, unit: "each"}, {name: "MaracuyÃ¡ (3)", price: 1.00, unit: "each"}, {name: "Aguacate", price: 1.10, unit: "each"}], colors: [0xff6347, 0xffffff] },
            { name: "Nia, la de los Dulces", pos: [0, 15], wares: [{name: "Conserva de Coco", price: 0.55, unit: "each"}, {name: "Dulce de Leche", price: 0.50, unit: "each"}, {name: "Alborotos", price: 0.25, unit: "each"}, {name: "Espumillas", price: 0.25, unit: "each"}, {name: "Tableta de Chocolate", price: 1.60, unit: "each"}, {name: "Galletas de Soda", price: 0.60, unit: "each"}, {name: "Refresco en Bolsa", price: 0.25, unit: "each"}, {name: "Churros", price: 0.50, unit: "each"}, {name: "Cocos Rallados", price: 1.00, unit: "each"}, {name: "Semita de PiÃ±a", price: 1.15, unit: "each"}], colors: [0xff69b4, 0xffffff] },
            { name: "Rocco, el Panadero", pos: [-15, 0], wares: [{name: "Pan FrancÃ©s", price: 0.25, unit: "each"}, {name: "Pan Dulce Variado", price: 0.40, unit: "each"}, {name: "Torta de Yema", price: 2.00, unit: "each"}, {name: "Pichardines", price: 0.50, unit: "each"}, {name: "Salpores de Arroz", price: 0.40, unit: "each"}, {name: "Quesadilla (porciÃ³n)", price: 1.30, unit: "each"}, {name: "Galletas de Avena", price: 0.75, unit: "each"}, {name: "Pan de Ajo", price: 1.50, unit: "each"}, {name: "Volteado de PiÃ±a", price: 1.50, unit: "each"}, {name: "Pastel de Chocolate", price: 1.85, unit: "each"}], colors: [0x808080, 0x000000] }
        ];

        characterData.forEach(data => {
            const characterGroup = new THREE.Group();
            const bodyGeo = new THREE.CylinderGeometry(0.4, 0.4, 1.2, 16);
            const bodyMat = new THREE.MeshStandardMaterial({ color: new THREE.Color().setHSL(Math.random(), 0.7, 0.6) });
            const body = new THREE.Mesh(bodyGeo, bodyMat);
            characterGroup.add(body);
            const headGeo = new THREE.SphereGeometry(0.3, 32, 32);
            const headMat = new THREE.MeshStandardMaterial({ color: 0xffccaa });
            const head = new THREE.Mesh(headGeo, headMat);
            head.position.y = 0.8;
            characterGroup.add(head);
            characterGroup.position.set(data.pos[0], 1, data.pos[1]);
            characterGroup.userData = { name: data.name, wares: data.wares, isCharacter: true, baseY: 1 };
            scene.add(characterGroup);
            characters.push(characterGroup);
            const stall = createStall(data.pos[0], data.pos[1] - 2, new THREE.Color(data.colors[0]), new THREE.Color(data.colors[1]));
            scene.add(stall);
        });

        const keys = {};
        document.addEventListener('keydown', (e) => keys[e.code] = true);
        document.addEventListener('keyup', (e) => keys[e.code] = false);

        const playerVelocity = new THREE.Vector3();
        const moveSpeed = 5.0;
        const lookSpeed = 2.0;
        
        const dialogueBox = document.getElementById('dialogue-box');
        const dialogueName = document.getElementById('dialogue-name');
        const dialogueContent = document.getElementById('dialogue-content');
        const interactionPrompt = document.getElementById('interaction-prompt');
        const cartSummary = document.getElementById('cart-summary');
        const cartItemsDiv = document.getElementById('cart-items');
        const paymentOptionsDiv = document.getElementById('payment-options');
        const interactionAreaDiv = document.getElementById('interaction-area');

        let currentCharacter = null;
        let tempQuantities = {};
        let currentCart = {};

        async function callGemini(prompt, schema = null) {
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
            };

            if (schema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: schema,
                };
            }

            try {
                const apiKey = "AIzaSyDUft77jEIeTBaVkU97ME04PeXFysJQVEc"; // Leave empty
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);

                const result = await response.json();
                if (!result.candidates || result.candidates.length === 0) throw new Error("Invalid API response structure");
                
                const text = result.candidates[0].content.parts[0].text;
                return schema ? JSON.parse(text) : text;

            } catch (error) {
                console.error("Error calling Gemini:", error);
                return null;
            }
        }

        function renderProductList() {
            let productListHTML = `<p>${t('todaysOffer')}</p><ul class="product-list">`;
            const cartTotal = calculateCartTotal();
            currentCharacter.userData.wares.forEach((ware) => {
                const quantity = tempQuantities[ware.name] || 0;
                const increment = ware.unit === 'pound' ? 0.25 : 1;
                const canAffordNext = playerBudget >= (cartTotal + ware.price * increment);
                const displayQuantity = ware.unit === 'pound' ? quantity.toFixed(2) : quantity;

                productListHTML += `
                    <li>
                        <div>
                            <div class="product-name">${ware.name}</div>
                            <div class="product-price">$${ware.price.toFixed(2)} / ${t('unit_' + ware.unit)}</div>
                        </div>
                        <div class="quantity-selector">
                            <button class="quantity-btn" onclick="updateQuantity('${ware.name}', -1)">-</button>
                            <span class="quantity-display">${displayQuantity}</span>
                            <button class="quantity-btn" onclick="updateQuantity('${ware.name}', 1)" ${canAffordNext ? '' : 'disabled'}>+</button>
                        </div>
                        <button class="add-to-cart-btn" onclick="addToCart('${ware.name}')" ${quantity > 0 ? '' : 'disabled'}>${t('addToCartButton')}</button>
                    </li>`;
            });
            productListHTML += `</ul>`;
            dialogueContent.innerHTML = productListHTML;
        }
        
        async function askQuestion() {
            const interactionDisplay = document.getElementById('interaction-display');
            const questionInput = document.getElementById('interaction-input');
            const askButton = document.getElementById('ask-question-btn');
            const question = questionInput.value;
            if (!question.trim()) return;

            interactionDisplay.style.display = 'block';
            interactionDisplay.innerHTML = `<p>${t('generating')}</p>`;
            askButton.disabled = true;

            const productListString = currentCharacter.userData.wares.map(w => w.name).join(', ');
            const schema = {
                type: "OBJECT",
                properties: {
                    action: { type: "STRING", enum: ["ADD_TO_CART", "CONFIRM_ADD", "CHAT"] },
                    items: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                productName: { type: "STRING" },
                                quantity: { type: "NUMBER" },
                                originalRequest: { type: "STRING" }
                            }
                        }
                    },
                    response: { type: "STRING" }
                },
                required: ["action", "response"]
            };

            const prompt = `Eres ${currentCharacter.userData.name}, un vendedor de mercado. Tus productos son: ${productListString}. El cliente dice: "${question}". Analiza su peticiÃ³n.
            - Si pide un producto con una cantidad numÃ©rica exacta (ej. '2 libras', '1.5 kg'), pon la acciÃ³n en "ADD_TO_CART".
            - Si pide un producto con una cantidad fraccionaria o verbal no exacta (ej. 'media libra', 'un cuarto de kilo'), pon la acciÃ³n en "CONFIRM_ADD".
            - Si solo es una pregunta general, pon la acciÃ³n en "CHAT".
            En todos los casos, extrae el nombre del producto, la cantidad numÃ©rica (convierte 'media' a 0.5, 'un cuarto' a 0.25, etc.), y la peticiÃ³n original (ej. 'media libra'). Da una respuesta amable y breve en espaÃ±ol.`;
            
            const result = await callGemini(prompt, schema);

            askButton.disabled = false;
            questionInput.value = '';

            if (result) {
                interactionDisplay.innerHTML = `<p>"${question}"</p><p>- ${result.response}</p>`;
                
                if (result.action === 'ADD_TO_CART' && result.items) {
                    result.items.forEach(item => {
                        const product = currentCharacter.userData.wares.find(w => w.name.toLowerCase() === item.productName.toLowerCase());
                        if (product) addItemToCart(product.name, item.quantity);
                    });
                } else if (result.action === 'CONFIRM_ADD' && result.items && result.items.length > 0) {
                    const item = result.items[0];
                    const product = currentCharacter.userData.wares.find(w => w.name.toLowerCase() === item.productName.toLowerCase());
                    if (product) {
                        const confirmationDiv = document.createElement('div');
                        confirmationDiv.innerHTML = `<p>Â¿Sabes que ${item.originalRequest} es ${item.quantity} ${t('unit_pound')}s? Â¿Lo agrego?</p>
                            <button id="confirm-yes">${t('confirm_add')}</button>
                            <button id="confirm-no">${t('confirm_cancel')}</button>`;
                        interactionDisplay.appendChild(confirmationDiv);

                        document.getElementById('confirm-yes').onclick = () => {
                            addItemToCart(product.name, item.quantity);
                            interactionDisplay.innerHTML = `<p>Â¡Agregado!</p>`;
                            setTimeout(() => { interactionDisplay.style.display = 'none'; }, 2000);
                        };
                        document.getElementById('confirm-no').onclick = () => {
                            interactionDisplay.style.display = 'none';
                        };
                    }
                }
            } else {
                interactionDisplay.innerHTML = `<p>Lo siento, no te he entendido bien.</p>`;
            }
        }

        function startDialogue(character) {
            currentCharacter = character;
            currentCart = {};
            tempQuantities = {};
            dialogueBox.style.display = 'flex';
            dialogueName.textContent = character.userData.name;
            cartSummary.style.display = 'none';
            
            interactionAreaDiv.innerHTML = `
                <input type="text" id="interaction-input" placeholder="${t('askPlaceholder')}">
                <button id="ask-question-btn" class="interaction-btn">${t('askQuestionButton')}</button>
                <div id="interaction-display" style="display:none;"></div>
            `;
            document.getElementById('ask-question-btn').onclick = askQuestion;

            updateCartDisplay();
            renderProductList();
        }

        window.updateQuantity = (itemName, change) => {
            let currentQuantity = tempQuantities[itemName] || 0;
            const item = currentCharacter.userData.wares.find(w => w.name === itemName);
            const increment = item.unit === 'pound' ? 0.25 : 1;
            const effectiveChange = change * increment;
            
            if (change > 0) {
                 const cartTotal = calculateCartTotal();
                 if (playerBudget >= (cartTotal + item.price * increment)) {
                    currentQuantity += effectiveChange;
                 }
            } else {
                currentQuantity = Math.max(0, currentQuantity + effectiveChange);
            }
            
            tempQuantities[itemName] = currentQuantity;
            renderProductList();
        };
        
        function addItemToCart(itemName, quantity) {
             const item = currentCharacter.userData.wares.find(w => w.name === itemName);
             if (!item) return;

             const totalCost = item.price * quantity;
             if (playerBudget >= (calculateCartTotal() + totalCost)) {
                currentCart[itemName] = (currentCart[itemName] || 0) + quantity;
                updateCartDisplay();
                renderProductList();
             }
        }

        window.addToCart = (itemName) => {
            const quantity = tempQuantities[itemName];
            if (quantity > 0) {
                addItemToCart(itemName, quantity);
                tempQuantities[itemName] = 0;
                updateCartDisplay();
                renderProductList();
            }
        };

        function calculateCartTotal() {
            let total = 0;
            for (const itemName in currentCart) {
                const item = currentCharacter.userData.wares.find(w => w.name === itemName);
                total += item.price * currentCart[itemName];
            }
            return total;
        }

        function generatePaymentOptions(total) {
            const options = [];
            const bills = [1, 5, 10, 20, 50, 100];
            options.push({ amount: total, isExact: true });
            let foundBills = 0;
            for (const bill of bills) {
                if (bill > total && foundBills < 2) {
                    options.push({ amount: bill, isExact: false });
                    foundBills++;
                }
            }
            return options.slice(0, 3);
        }

        function handlePayment(total) {
            if (playerBudget >= total) {
                playerBudget -= total;
                updateBudgetDisplay();
                closeDialogue();
            }
        }

        function updateCartDisplay() {
            const total = calculateCartTotal();
            if (total > 0) {
                cartSummary.style.display = 'block';
                cartItemsDiv.innerHTML = '';
                for (const itemName in currentCart) {
                    const quantity = currentCart[itemName];
                    const item = currentCharacter.userData.wares.find(w => w.name === itemName);
                    const displayQuantity = item.unit === 'pound' ? quantity.toFixed(2) : quantity;
                    const itemDiv = document.createElement('div');
                    itemDiv.textContent = `${displayQuantity} ${item.unit === 'pound' ? t('unit_pound')+'s' : ''} de ${itemName}`;
                    cartItemsDiv.appendChild(itemDiv);
                }
                
                paymentOptionsDiv.innerHTML = '';
                if (playerBudget >= total) {
                    const paymentOptions = generatePaymentOptions(total);
                    paymentOptions.forEach(option => {
                        const button = document.createElement('button');
                        button.className = 'payment-option-btn';
                        let buttonText = '';
                        if (option.isExact) {
                            buttonText = `${t('payButton')} ($${option.amount.toFixed(2)} ${t('exacto')})`;
                        } else {
                            const change = option.amount - total;
                            buttonText = `${t('payWith')} $${option.amount.toFixed(2)} (${t('change')}: $${change.toFixed(2)})`;
                        }
                        button.textContent = buttonText;
                        button.onclick = () => handlePayment(total);
                        paymentOptionsDiv.appendChild(button);
                    });
                }

            } else {
                cartSummary.style.display = 'none';
            }
        }

        function closeDialogue() {
            dialogueBox.style.display = 'none';
            currentCharacter = null;
            document.exitPointerLock();
        }

        document.addEventListener('keydown', (e) => {
            if (e.code === 'KeyE' && !currentCharacter) {
                const nearbyCharacter = characters.find(c => camera.position.distanceTo(c.position) < 3.5);
                if (nearbyCharacter) {
                    startDialogue(nearbyCharacter);
                }
            } else if (e.code === 'Escape') {
                if (currentCharacter) {
                    closeDialogue();
                } else {
                     document.exitPointerLock();
                }
            }
        });
        
        const clock = new THREE.Clock();
        let mouseX = 0;

        function animate() {
            requestAnimationFrame(animate);
            const deltaTime = clock.getDelta();

            if (document.pointerLockElement === renderer.domElement) {
                playerVelocity.set(0, 0, 0);
                if (keys['KeyW']) playerVelocity.z = -1;
                if (keys['KeyS']) playerVelocity.z = 1;
                if (keys['KeyA']) playerVelocity.x = -1;
                if (keys['KeyD']) playerVelocity.x = 1;

                const moveVector = playerVelocity.clone().normalize().multiplyScalar(moveSpeed * deltaTime);
                moveVector.applyAxisAngle(new THREE.Vector3(0,1,0), mouseX);
                
                camera.position.add(moveVector);

                if (keys['ArrowLeft']) mouseX += lookSpeed * deltaTime;
                if (keys['ArrowRight']) mouseX -= lookSpeed * deltaTime;
            }
            
            camera.rotation.y = mouseX;

            characters.forEach(char => {
                const bobble = Math.sin(performance.now() * 0.001 + char.id) * 0.05;
                char.position.y = char.userData.baseY + bobble;
                char.rotation.y = Math.sin(performance.now() * 0.0005 + char.id) * 0.2;
            });
            
            const nearbyCharacter = characters.find(c => camera.position.distanceTo(c.position) < 3.5);
            if (nearbyCharacter && !currentCharacter) {
                interactionPrompt.style.display = 'block';
                interactionPrompt.textContent = `${t('pressEToTalkTo')} ${nearbyCharacter.userData.name}`;
            } else {
                interactionPrompt.style.display = 'none';
            }
            
            renderer.render(scene, camera);
        }
        
        window.addEventListener('resize', () => {
            const width = canvasContainer.clientWidth;
            const height = canvasContainer.clientHeight;
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        });
        
        document.addEventListener('mousemove', (e) => {
            if (document.pointerLockElement === renderer.domElement) {
                mouseX -= e.movementX * 0.002;
            }
        });
        
        const startButton = document.getElementById('start-button');
        const startOverlay = document.getElementById('start-overlay');
        startButton.addEventListener('click', () => {
            startOverlay.style.display = 'none';
            // We don't request pointer lock here anymore.
            // It will be requested on the next click on the canvas.
        });

        renderer.domElement.addEventListener('click', () => {
            if (document.pointerLockElement !== renderer.domElement) {
                 renderer.domElement.requestPointerLock();
            }
        });
        
        animate();
    </script>
</body>
</html>
